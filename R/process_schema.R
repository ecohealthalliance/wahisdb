#' .. content for \description{} (no empty lines) ..
#'
#' .. content for \details{} ..
#'
#' @title
#' @param schema_extract
#' @param wahis_tables
#' @return
#' @author Emma Mendelsohn
#' @export
process_schema <- function(schema_extract, wahis_tables, six_month_table, control_measures_table, disease_key) {

  schema_extract <- schema_extract |>
    janitor::clean_names() |>
    mutate_if(is.character, tolower)  |>
    mutate(field = janitor::make_clean_names(field))

  ### wahis_epi_events (with disease key)
  wahis_epi_events_schema <- tibble(table = "wahis_epi_events",
                                    field = colnames(wahis_tables$wahis_epi_events),
                                    field_type = map_chr(wahis_tables$wahis_epi_events, ~class(.)[1])) |>
    left_join(schema_extract) |>
    mutate(field_description = case_when(field == "epi_event_id_unique" ~ "for most events, this is the same as epi_event_id. for events with reporting by strain or serotype, the epi_event_id is combined with the strain or serotype (this field is generated by EHA)",
                                         .default = field_description)) |>
    mutate(primary_key = ifelse(field == "epi_event_id_unique", "*", "")) |>
    mutate(foreign_key = ifelse(field == "epi_event_id_unique", "epi_event_id_unique in wahis_outbreaks (one to many)", "")) |>
    mutate(generated_field = field == "epi_event_id_unique" | is.na(field_description))

  disease_key_schema <- tibble(field = colnames(disease_key)) |>
    mutate(disease_descripton = c("disease name following ANDO standardization (this is an intermediary state)",
                                  "cleaned/standardized disease name",
                                  "alternate name for disease",
                                  "pathogen taxonomy group (`bacteria`,  `virus`,  `eukaryote`, `prion`,  NA)",
                                  "pathogen taxonomy order",
                                  "pathogen taxonomy family",
                                  "pathogen taxonomy genus",
                                  "pathogen taxonomy species",
                                  "pathogen name abbreviation",
                                  "additional information on the disease",
                                  "additional information on the disease",
                                  "additional information on the disease",
                                  "pathogen vector if applicable"))

  wahis_epi_events_schema <- left_join(wahis_epi_events_schema, disease_key_schema) |>
    mutate(field_description = coalesce(field_description, disease_descripton)) |>
    select(-disease_descripton)

  ### wahis_outbreaks (with disease key)
  wahis_outbreaks_schema <- tibble(table = "wahis_outbreaks",
                                   field = colnames(wahis_tables$wahis_outbreaks),
                                   field_type = map_chr(wahis_tables$wahis_outbreaks, ~class(.)[1])) |>
    left_join(schema_extract) |>
    mutate(field_description = case_when(field == "report_outbreak_species_id_unique" ~ "unique combination of report_id, outbreak_id, and species (this field is generated by EHA)",
                                         .default = field_description)) |>
    mutate(field_description = case_when(field == "epi_event_id_unique" ~ "for most events, this is the same as epi_event_id. for events with reporting by strain or serotype, the epi_event_id is combined with the strain or serotype (this field is generated by EHA)",
                                         .default = field_description)) |>
    mutate(primary_key = ifelse(field == "report_outbreak_species_id_unique", "*", "")) |>
    mutate(foreign_key = ifelse(field == "epi_event_id_unique", "epi_event_id_unique in wahis_epi_events (many to one)", "")) |>
    mutate(generated_field = field %in% c("epi_event_id_unique", "report_outbreak_species_id_unique"))

  ### wahis_six_month_reports (with disease key)
  wahis_six_month_schema <- tibble(table = "wahis_six_month_reports",
                                   field = colnames(six_month_table$wahis_six_month_reports),
                                   field_type = map_chr(six_month_table$wahis_six_month_reports, ~class(.)[1])) |>
    mutate(field_description = case_when(field == "unique_id" ~ "unique id",
                                         field == "year" ~ "report year",
                                         field == "semester" ~ "jan-jun or jul-dec",
                                         field == "region" ~ "geographical region",
                                         field == "country" ~ "country name",
                                         field == "disease" ~ "disease name",
                                         field == "disease_status" ~ "disease status",
                                         field == "occurence_code" ~ "disease status with slightly more detail",
                                         field == "animal_category" ~ "domestic or wild",
                                         field == "semester_code" ~ "1 for jan-jun and 2 for jul-dec",
                                         .default = NA)) |>
    left_join(disease_key_schema) |>
    mutate(field_description = coalesce(field_description, disease_descripton)) |>
    select(-disease_descripton) |>
    mutate(primary_key = ifelse(field == "unique_id", "*", "")) |>
    mutate(foreign_key = "") |>
    mutate(generated_field = field %in% c(disease_key_schema$field[-1], "unique_id","semester_code"))

  ### wahis_control_measures (with disease key)
  wahis_control_measures_schema <- tibble(table = "wahis_control_measures",
                                   field = colnames(control_measures_table$wahis_control_measures),
                                   field_type = map_chr(control_measures_table$wahis_control_measures, ~class(.)[1])) |>
    mutate(field_description = case_when(field == "unique_id" ~ "unique id",
                                         field == "year" ~ "report year",
                                         field == "semester" ~ "jan-jun or jul-dec",
                                         field == "region" ~ "geographical region",
                                         field == "country" ~ "country name",
                                         field == "disease" ~ "disease name",
                                         field == "species" ~ "taxa type",
                                         field == "control_measure" ~ "type of control measure applied",
                                         field == "animal_category" ~ "domestic or wild",
                                         field == "semester_code" ~ "1 for jan-jun and 2 for jul-dec",
                                         .default = NA)) |>
    left_join(disease_key_schema) |>
    mutate(field_description = coalesce(field_description, disease_descripton)) |>
    select(-disease_descripton) |>
    mutate(primary_key = ifelse(field == "unique_id", "*", "")) |>
    mutate(foreign_key = "") |>
    mutate(generated_field = field %in% c(disease_key_schema$field[-1], "unique_id","semester_code"))

  ### Full schema

  schema <- bind_rows(wahis_epi_events_schema, wahis_outbreaks_schema, wahis_six_month_schema, wahis_control_measures_schema) |>
    mutate(id = row_number()) |>
    relocate(id, .before = everything())

  assert_that(all(!is.na(schema$field_description)))

  return(schema)

}
